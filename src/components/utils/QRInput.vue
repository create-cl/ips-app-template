<template>
    <div
    @dragenter.prevent="onDragEnter"
    @dragover.prevent="onDragOver"
    @dragleave="onDragLeave"
    @drop.prevent="onDrop"
    @click="openFileDialog"
    style="border: 2px dotted var(--v-outline-variant-base); height: 100%; padding: 3%; border-radius: 1rem;"
    >
        <div v-if="imgSrc" class="d-flex justify-end mt-2">
            <v-btn @click="clearFile" icon>
                <v-icon>mdi-close</v-icon>
            </v-btn>
        </div>
        <div class="d-flex justify-center">
            <v-avatar v-if="imgSrc" size="150" tile class="mt-4 mb-4 mr-4 ml-4 rounded">
                <img :src="imgSrc" alt="QR Code Preview" />
            </v-avatar>
            <div v-else class="d-flex justify-center flex-column align-center">
                <svg width="100" height="82" viewBox="0 0 100 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.7061 81.2681L18.7962 80.7773L18.8864 80.2866C19.7648 80.4515 20.6897 80.4509 21.6205 80.2558L28.4187 78.8309L28.524 79.3197L28.6294 79.8085L21.8312 81.2333C20.7695 81.4559 19.7117 81.457 18.7061 81.2681ZM69.4186 71.2593L69.3132 70.7706L69.2078 70.2818L76.006 68.8569C76.9368 68.6619 77.782 68.2915 78.5164 67.7885L78.8012 68.2007L79.086 68.6129C78.2452 69.1888 77.2784 69.612 76.2168 69.8345L69.4186 71.2593ZM72.2834 13.6235L71.7941 13.7261L71.3047 13.8286L69.8651 7.15012C69.6647 6.22049 69.2891 5.37529 68.781 4.63991L69.1927 4.35794L69.6044 4.07597C70.186 4.91781 70.6152 5.88461 70.8438 6.94499L72.2834 13.6235ZM13.7408 10.7397L6.94261 12.1646C5.88095 12.3871 4.91413 12.8103 4.07335 13.3862L4.35813 13.7984L4.64291 14.2106C5.37735 13.7075 6.22257 13.3372 7.15333 13.1421L13.9515 11.7172L13.8462 11.2285L13.7408 10.7397ZM10.8759 68.3755L11.3653 68.273L11.8547 68.1704L13.2943 74.8489C13.4947 75.7785 13.8703 76.6237 14.3783 77.3591L13.9667 77.6411L13.555 77.9231C12.9734 77.0812 12.5441 76.1144 12.3156 75.0541L10.8759 68.3755ZM7.99667 55.0185L8.48603 54.916L8.9754 54.8134L6.09614 41.4564L5.60677 41.559L5.11741 41.6615L7.99667 55.0185ZM2.23814 28.3045L2.72751 28.2019L3.21688 28.0994L1.77725 21.4209C1.57686 20.4912 1.57136 19.5685 1.73216 18.6929L1.23976 18.6004L0.747356 18.5079C0.563285 19.5103 0.569938 20.5656 0.798514 21.626L2.23814 28.3045ZM27.3372 7.88998L27.4426 8.37876L27.5479 8.86753L41.1443 6.01782L41.0389 5.52905L40.9336 5.04027L27.3372 7.88998ZM54.53 2.19056L54.6353 2.67933L54.7407 3.16811L61.5389 1.74325C62.4697 1.54817 63.3946 1.5475 64.273 1.71249L64.3631 1.22171L64.4533 0.730929C63.4476 0.542054 62.3898 0.543187 61.3282 0.765703L54.53 2.19056ZM75.1627 26.9805L74.6733 27.0831L74.184 27.1856L77.0632 40.5426L77.5526 40.4401L78.042 40.3375L75.1627 26.9805ZM80.9212 53.6945L80.4318 53.7971L79.9425 53.8997L81.3821 60.5782C81.5825 61.5078 81.588 62.4306 81.4272 63.3061L81.9196 63.3986L82.412 63.4911C82.5961 62.4888 82.5894 61.4334 82.3608 60.373L81.5116 56.4334L83.3417 56.7192C84.6814 56.9284 86.0016 56.8615 87.2441 56.5607L87.1281 56.0751L87.0121 55.5895C85.8953 55.8599 84.7079 55.9204 83.5003 55.7319L81.2858 55.386L80.9212 53.6945ZM55.8222 74.1091L55.7168 73.6203L55.6114 73.1315L42.0151 75.9812L42.1204 76.47L42.2258 76.9588L55.8222 74.1091ZM25.8623 31.7668L35.4192 29.4172L37.802 38.8409L28.2451 41.1905L25.8623 31.7668ZM51.3473 25.5013L53.7301 34.9249L44.1733 37.2745L41.7905 27.8509L51.3473 25.5013ZM46.1589 45.1275L49.3445 44.3444L50.5359 49.0562L45.7575 50.231L46.5518 53.3722L43.3661 54.1554L41.7776 47.8729L46.5561 46.6982L46.1589 45.1275ZM53.7216 48.273L50.5359 49.0562L51.3302 52.1974L54.5158 51.4142L53.7216 48.273ZM52.5302 43.5612L49.3445 44.3444L48.5503 41.2031L51.7359 40.4199L52.5302 43.5612ZM51.7359 40.4199L50.9416 37.2787L54.1273 36.4955L54.9215 39.6368L51.7359 40.4199ZM52.5302 43.5612L53.7216 48.273L56.9072 47.4898L55.7158 42.778L52.5302 43.5612ZM47.756 38.0619L48.5503 41.2031L45.3647 41.9863L44.5704 38.8451L47.756 38.0619ZM32.2165 56.8966L29.8337 47.4729L39.3905 45.1233L41.7733 54.547L32.2165 56.8966ZM29.8422 34.1249L30.6365 37.2661L33.8221 36.4829L33.0278 33.3417L29.8422 34.1249ZM45.7704 30.2089L46.5646 33.3501L49.7502 32.5669L48.956 29.4257L45.7704 30.2089ZM33.8135 49.8309L34.6078 52.9721L37.7934 52.1889L36.9992 49.0477L33.8135 49.8309ZM28.6423 42.7611L31.8279 41.9779L32.6221 45.1191L29.4365 45.9023L28.6423 42.7611ZM36.6063 40.8031L42.9776 39.2367L44.5661 45.5191L41.3805 46.3023L40.5862 43.1611L37.4006 43.9443L36.6063 40.8031ZM37.8063 32.1669L40.9919 31.3837L42.5804 37.6661L39.3948 38.4493L37.8063 32.1669ZM21.8824 29.4088L23.471 35.6912L20.2853 36.4744L18.6968 30.192C18.4862 29.3589 18.6198 28.4774 19.0682 27.7414C19.5167 27.0055 20.2433 26.4753 21.0882 26.2676L27.4594 24.7012L28.2537 27.8424L21.8824 29.4088ZM52.9444 18.4357C53.7893 18.2279 54.6833 18.3597 55.4296 18.8019C56.176 19.2441 56.7137 19.9606 56.9243 20.7937L58.5129 27.0761L55.3272 27.8593L53.7387 21.5769L47.3674 23.1433L46.5732 20.002L52.9444 18.4357ZM28.2366 54.5385L29.8251 60.821L36.1963 59.2546L36.9906 62.3958L30.6194 63.9622C29.7745 64.1699 28.8805 64.0382 28.1341 63.5959C27.3878 63.1537 26.8501 62.4373 26.6395 61.6042L25.0509 55.3217L28.2366 54.5385ZM61.6814 52.989L60.0928 46.7066L63.2785 45.9234L64.867 52.2058C65.0776 53.0389 64.944 53.9204 64.4956 54.6564C64.0471 55.3924 63.3205 55.9225 62.4756 56.1302L56.1044 57.6966L55.3101 54.5554L61.6814 52.989ZM98.1569 27.5385L97.6629 27.4613L97.1689 27.3842L98.2853 20.4341C98.4791 19.2274 98.4234 18.0417 98.1572 16.9275L98.6439 16.8097L99.1306 16.6918C99.4267 17.9314 99.4883 19.2496 99.2733 20.5884L98.1569 27.5385ZM83.8642 8.06071L83.7849 8.55438L83.7056 9.04805L90.8204 10.1592C92.0279 10.3478 93.1383 10.7672 94.1157 11.3647L94.3782 10.9382L94.6407 10.5117C93.5532 9.84704 92.3186 9.38109 90.979 9.17187L83.8642 8.06071ZM95.9242 41.4387L95.4302 41.3615L94.9362 41.2844L93.8199 48.2345C93.626 49.4412 93.2015 50.5519 92.5992 51.5304L93.0251 51.7908L93.4511 52.0512C94.1212 50.9625 94.5928 49.7276 94.8079 48.3888L95.9242 41.4387Z" fill="#A7C8FF"/>
                </svg>
                <p>{{ $t('qr_input.label')}}</p>
            </div>
        </div>
        <input 
            type="file" 
            ref="fileInput" 
            accept="image/*" 
            style="display: none;" 
            @change="onFileSelected"
        />
    </div>
</template>

<script>
import jsQR from 'jsqr';

export default {
    name: 'QRInput', 
    data() {
        return {
            imgSrc: "",
            isDragging: false,
        };
    },
    methods: {
        openFileDialog() {
            this.$refs.fileInput.click();
        },
        onFileSelected(event) {
            const file = event.target.files[0];
            if (file) {
                this.processFile(file);
            } else {
                this.imgSrc = "";
                this.$emit('qr-code-parsed', null);
            }
        },
        onDragEnter() {
            this.isDragging = true;
        },
        onDragOver() {
            this.isDragging = true;
        },
        onDragLeave() {
            this.isDragging = false;
        },
        onDrop(event) {
            this.isDragging = false;
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                this.processFile(file);
            } else {
                this.$emit('qr-code-parsed', null);
            }
        },
        processFile(file){
                this.imgSrc = URL.createObjectURL(file);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        if (code) {
                            this.$emit('qr-code-parsed', code);
                        } else {
                            this.$emit('qr-code-parsed', null)
                        }
                    };
                };
                
                reader.readAsDataURL(file);
        },
        clearFile(event) {
            event.stopPropagation();
            this.imgSrc = "";
            this.$refs.fileInput.value = null;
            this.$emit('qr-code-parsed', null);
        }
    }
}

</script>

<style>
.v-file-input .v-file-input__text {
    justify-content: center !important;
}
</style> 